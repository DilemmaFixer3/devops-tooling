#!/bin/bash

# ==============================================================================
# Configuration
# ==============================================================================

# Regex äëÿ ïåðåâ³ðêè ÷àñòèíè ³ìåí³ ôàéëó (äî êðàïêè).
# Âèìîãè: [a-z][a-z0-9_-]*[a-z0-9]
# - Ïî÷èíàºòüñÿ ç [a-z]
# - Âñåðåäèí³ ìîæóòü áóòè [a-z0-9_-]
# - Çàê³í÷óºòüñÿ íà [a-z0-9]
NAME_PATTERN="[a-z][a-z0-9_-]*[a-z0-9]"

# Ï³äòðèìóâàí³ ðîçøèðåííÿ (pipe-separated)
EXTENSIONS='py|txt|js|java|c'

# Êîìá³íàö³ÿ øàáëîíó ³ìåí³ òà ðîçøèðåíü
FILE_PATTERN="$NAME_PATTERN\.($EXTENSIONS)"

# Ë³÷èëüíèê ïîìèëîê
ERRORS=0

# ==============================================================================
# Usage and Validation
# ==============================================================================

# Ïåðåâ³ðêà íàÿâíîñò³ àðãóìåíòó (ö³ëüîâî¿ äèðåêòîð³¿)
if [ -z "$1" ]; then
    echo "Ïîìèëêà: Íåîáõ³äíî âêàçàòè øëÿõ äî äèðåêòîð³¿."
    echo "Ñèíòàêñèñ: ./check-filename.sh <path_to_directory>"
    exit 1
fi

TARGET_DIR="$1"

# Ïåðåâ³ðêà, ÷è äèðåêòîð³ÿ ³ñíóº
if [ ! -d "$TARGET_DIR" ]; then
    echo "Ïîìèëêà: Âêàçàíèé øëÿõ '$TARGET_DIR' íå º ä³éñíîþ äèðåêòîð³ºþ."
    exit 1
fi

# ==============================================================================
# Core Validation Logic
# ==============================================================================

echo "--- Çàïóñê ïåðåâ³ðêè ³ìåíóâàííÿ ôàéë³â ó äèðåêòîð³¿: $TARGET_DIR ---"

# Âèêîðèñòàííÿ find äëÿ ðåêóðñèâíîãî ïîøóêó ï³äòðèìóâàíèõ ôàéë³â.
# Ñïî÷àòêó ôîðìóºìî regex äëÿ find: .*\.(py|txt|js|java|c)
FIND_REGEX=".*\.\($EXTENSIONS\)"

# -type f: øóêàòè ò³ëüêè ôàéëè
# -regex: âèêîðèñòîâóâàòè ðåãóëÿðíèé âèðàç äëÿ ïîøóêó ôàéë³â ç ïîòð³áíèìè ðîçøèðåííÿìè
find "$TARGET_DIR" -type f -regex "$FIND_REGEX" | while IFS= read -r FILE_PATH; do
    # Âèäîáóâàºìî ëèøå íàçâó ôàéëó ç ïîâíîãî øëÿõó
    FILENAME=$(basename "$FILE_PATH")

    # Âèêîíóºìî ïåðåâ³ðêó çà äîïîìîãîþ ðåãóëÿðíîãî âèðàçó
    # ^: ïî÷àòîê ðÿäêà, $: ê³íåöü ðÿäêà.
    # Øàáëîí $FILE_PATTERN â³äïîâ³äàº âèìîãàì ç README: NAME_PATTERN\.($EXTENSIONS)
    if [[ ! "$FILENAME" =~ ^$FILE_PATTERN$ ]]; then
        echo "[ÏÎÌÈËÊÀ] Ôàéë íå â³äïîâ³äàº êîíâåíö³¿: $FILE_PATH"
        ERRORS=$((ERRORS + 1))
    else
        echo "[Óñï³õ] Íàçâà â³äïîâ³äàº: $FILE_PATH"
    fi
done

# ==============================================================================
# Directory Validation Logic (NEW BLOCK)
# ==============================================================================

echo "--- Запуск перевірки іменування директорій у: $TARGET_DIR ---"

# -type d: шукати тільки директорії
# ! -path: ігнорувати службові папки Git та поточну папку
find "$TARGET_DIR" -type d \( -path "$TARGET_DIR/.git" -o -path "$TARGET_DIR/." -o -path "$TARGET_DIR/.." \) -prune -o -print | while IFS= read -r DIR_PATH; do
    # Отримуємо тільки назву директорії
    DIR_NAME=$(basename "$DIR_PATH")
    
    # Ігноруємо порожні назви
    if [ -z "$DIR_NAME" ]; then
        continue
    fi

    # Використовуємо той самий NAME_PATTERN
    if [[ ! "$DIR_NAME" =~ ^$NAME_PATTERN$ ]]; then
        echo "[ПОМИЛКА] Директорія не відповідає конвенції: $DIR_PATH"
        ERRORS=$((ERRORS + 1))
    else
        echo "[Успіх] Назва директорії відповідає: $DIR_PATH"
    fi
done

# ==============================================================================
# Exit Code
# ==============================================================================

echo "--- Ïåðåâ³ðêà çàâåðøåíà ---"

if [ "$ERRORS" -eq 0 ]; then
    echo "Êîä âèõîäó 0: Âñ³ çíàéäåí³ ôàéëè ïðîéøëè ïåðåâ³ðêó ÿêîñò³."
    exit 0
else
    echo "Êîä âèõîäó 1: Ïåðåâ³ðêà ÿêîñò³ çàâåðøèëàñÿ ïîìèëêîþ. Çíàéäåíî ïîìèëîê: $ERRORS."
    exit 1
fi
