#!/bin/bash

# ==============================================================================
# Configuration
# ==============================================================================

# Regex для перевірки частини імені файлу (до крапки).
# Вимоги: [a-z][a-z0-9_-]*[a-z0-9]
# - Починається з [a-z]
# - Всередині можуть бути [a-z0-9_-]
# - Закінчується на [a-z0-9]
NAME_PATTERN="[a-z][a-z0-9_-]*[a-z0-9]"

# Підтримувані розширення (pipe-separated)
EXTENSIONS='py|txt|js|java|c'

# Комбінація шаблону імені та розширень
FILE_PATTERN="$NAME_PATTERN\.($EXTENSIONS)"

# Лічильник помилок
ERRORS=0

# ==============================================================================
# Usage and Validation
# ==============================================================================

# Перевірка наявності аргументу (цільової директорії)
if [ -z "$1" ]; then
    echo "Помилка: Необхідно вказати шлях до директорії."
    echo "Синтаксис: ./check-filename.sh <path_to_directory>"
    exit 1
fi

TARGET_DIR="$1"

# Перевірка, чи директорія існує
if [ ! -d "$TARGET_DIR" ]; then
    echo "Помилка: Вказаний шлях '$TARGET_DIR' не є дійсною директорією."
    exit 1
fi

# ==============================================================================
# Core Validation Logic
# ==============================================================================

echo "--- Запуск перевірки іменування файлів у директорії: $TARGET_DIR ---"

# Використання find для рекурсивного пошуку підтримуваних файлів.
# Спочатку формуємо regex для find: .*\.(py|txt|js|java|c)
FIND_REGEX=".*\.\($EXTENSIONS\)"

# -type f: шукати тільки файли
# -regex: використовувати регулярний вираз для пошуку файлів з потрібними розширеннями
find "$TARGET_DIR" -type f -regex "$FIND_REGEX" | while IFS= read -r FILE_PATH; do
    # Видобуваємо лише назву файлу з повного шляху
    FILENAME=$(basename "$FILE_PATH")

    # Виконуємо перевірку за допомогою регулярного виразу
    # ^: початок рядка, $: кінець рядка.
    # Шаблон $FILE_PATTERN відповідає вимогам з README: NAME_PATTERN\.($EXTENSIONS)
    if [[ ! "$FILENAME" =~ ^$FILE_PATTERN$ ]]; then
        echo "[ПОМИЛКА] Файл не відповідає конвенції: $FILE_PATH"
        ERRORS=$((ERRORS + 1))
    else
        echo "[Успіх] Назва відповідає: $FILE_PATH"
    fi
done

# ==============================================================================
# Exit Code
# ==============================================================================

echo "--- Перевірка завершена ---"

if [ "$ERRORS" -eq 0 ]; then
    echo "Код виходу 0: Всі знайдені файли пройшли перевірку якості."
    exit 0
else
    echo "Код виходу 1: Перевірка якості завершилася помилкою. Знайдено помилок: $ERRORS."
    exit 1
fi