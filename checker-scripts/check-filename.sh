#!/bin/bash

# ==============================================================================
# Configuration
# ==============================================================================

NAME_PATTERN="[a-z][a-z0-9_-]*[a-z0-9]"
EXTENSIONS='py|txt|js|java|c|md'
ERRORS_FILE="errors.tmp" # Файл для тимчасового зберігання помилок

# ==============================================================================
# Setup
# ==============================================================================
rm -f $ERRORS_FILE # Очистити старий файл помилок

if [ -z "$1" ]; then
    echo "[СИСТЕМА] Помилка: Необхідно вказати шлях до директорії."
    exit 1
fi
TARGET_DIR="$1"

# ==============================================================================
# Directory Validation Logic
# ==============================================================================

# Використовуємо '-exec' для коректної обробки
find "$TARGET_DIR" -type d \( -path "$TARGET_DIR/.git" \) -prune -o -print | while IFS= read -r DIR_PATH; do
    DIR_NAME=$(basename "$DIR_PATH")
    
    # Ігноруємо порожні назви або .
    if [[ -z "$DIR_NAME" || "$DIR_NAME" == "." ]]; then continue; fi

    # Перевірка
    if [[ ! "$DIR_NAME" =~ ^$NAME_PATTERN$ ]]; then
        echo "[ПОМИЛКА] Директорія не відповідає конвенції: $DIR_PATH" >> $ERRORS_FILE
    fi
done

# ==============================================================================
# File Validation Logic
# ==============================================================================

# Тут ми можемо залишити ваш цикл 'while'
FIND_REGEX=".*\.\($EXTENSIONS\)"
find "$TARGET_DIR" -type f -regex "$FIND_REGEX" | while IFS= read -r FILE_PATH; do
    FILENAME=$(basename "$FILE_PATH")
    
    # Перевірка, що назва файлу (без шляху) відповідає патерну
    if [[ ! "$FILENAME" =~ ^$NAME_PATTERN\.$EXTENSIONS$ ]]; then
        echo "[ПОМИЛКА] Файл не відповідає конвенції: $FILE_PATH" >> $ERRORS_FILE
    fi
done

# ==============================================================================
# Exit Code (Фінальна перевірка)
# ==============================================================================

if [ -s "$ERRORS_FILE" ]; then
    echo "--- ЗНАЙДЕНО ПОРУШЕННЯ ІМЕНУВАННЯ ---"
    cat $ERRORS_FILE
    rm -f $ERRORS_FILE
    exit 1 # ГАРАНТОВАНО ВИКЛИКАЄ FAILURE
else
    echo "SUCCESS: Всі файли та директорії пройшли перевірку."
    rm -f $ERRORS_FILE
    exit 0
fi